name: DevSecOps Secure Supply Chain

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_REPO: ${{ github.repository }}

jobs:
  build:
    name: 1 - Build and Analyze
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.set-image.outputs.image }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Go Module Files
        run: |
          if [[ ! -f app/go.mod || ! -f app/go.sum ]]; then
            echo "Error: app/go.mod or app/go.sum missing."
            exit 1
          fi

      - name: Set image tag
        id: set-image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ github.sha }}"
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./app
          file: ./app/Dockerfile
          load: true
          push: false
          tags: ${{ steps.set-image.outputs.image }}

      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.set-image.outputs.image }}
          format: cyclonedx-json
          output-file: bom.json

      - name: Scan for Vulnerabilities (Grype)
        uses: anchore/scan-action@v6
        with:
          sbom: bom.json
          output-file: vulnerabilities.json
          output-format: json
          fail-build: false

      - name: Save Docker image to tarball
        run: docker save ${{ steps.set-image.outputs.image }} -o /tmp/docker-image.tar

      - name: Upload Artifacts (SBOM & Scan)
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bom.json
            vulnerabilities.json
          retention-days: 7

      - name: Upload Docker Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-image.tar
          retention-days: 7

  policy-gate:
    name: 2 - Enforce Security Policy
    runs-on: ubuntu-latest
    needs: [build]
    outputs:
      image_tag: ${{ needs.build.outputs.image_tag }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: .

      - name: Install OPA
        run: |
          curl -L -o /tmp/opa https://github.com/open-policy-agent/opa/releases/latest/download/opa_linux_amd64
          chmod +x /tmp/opa
          sudo mv /tmp/opa /usr/local/bin/opa

      - name: Create OPA input JSON
        run: |
          jq -n --slurpfile grype vulnerabilities.json --slurpfile syft bom.json \
            '{"vulnerabilities": $grype[0], "sbom": $syft[0]}' > input.json

      - name: Run OPA Policy Gate
        id: opa_eval
        run: |
          RESULT=$(opa eval -i input.json -d ./policy 'data.main.allow' --format=json 2>&1) || true
          PASSED=$(echo "$RESULT" | jq -r '.result[0].expressions[0].value // "false"')
          echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          if [ "$PASSED" != "true" ]; then
            DENY=$(opa eval -i input.json -d ./policy 'data.main.deny' --format=json 2>/dev/null || true)
            echo "OPA Policy DENY output: $DENY"
            exit 1
          fi
          echo "OPA Policy PASSED"

  sign-and-publish:
    name: 3 - Attest and Publish
    runs-on: ubuntu-latest
    needs: [policy-gate]
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/docker-image.tar

      - name: Set IMAGE variable from upstream
        run: echo "IMAGE=${{ needs.policy-gate.outputs.image_tag }}" >> $GITHUB_OUTPUT
        id: setimage

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Docker image to registry
        run: docker push ${{ steps.setimage.outputs.IMAGE }}

      - name: Get image digest
        id: digest
        run: |
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ steps.setimage.outputs.IMAGE }})
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      - name: Download SBOM artifact
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: .

      - name: Install Sigstore/cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign image with Cosign (keyless)
        env:
          COSIGN_EXPERIMENTAL: 1
        run: cosign sign --yes ${{ steps.digest.outputs.digest }}

      - name: Attach SBOM Attestation
        env:
          COSIGN_EXPERIMENTAL: 1
        run: cosign attest --yes --type cyclonedx --predicate ./bom.json ${{ steps.digest.outputs.digest }}

      - name: Verify Image Signature
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          cosign verify \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            --certificate-identity-regexp "^https://github.com/${{ github.repository }}/.*" \
            ${{ steps.digest.outputs.digest }}

      - name: Verify SBOM Attestation
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          cosign verify-attestation \
            --type cyclonedx \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            --certificate-identity-regexp "^https://github.com/${{ github.repository }}/.*" \
            ${{ steps.digest.outputs.digest }}