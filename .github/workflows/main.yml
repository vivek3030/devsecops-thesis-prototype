# ============================================
# SLSA Level 3 DevSecOps Secure Supply Chain
# ============================================
# This workflow achieves your thesis goal:
# 1. ACHIEVES SLSA L3 using the official, hermetic slsa-github-generator.
# 2. INTEGRATES SBOM/Scanning by adding a job that pulls the L3 image and
#    runs Syft, Grype, and OPA against it.
# 3. COLLECTS metrics on the entire, unified process.

name: SLSA L3 DevSecOps Secure Supply Chain

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_REPO: ${{ github.repository }}
  # Define the image name here to be consistent
  IMAGE_NAME: ghcr.io/${{ github.repository }}

permissions:
  # This is required by the SLSA L3 generator
  contents: read

jobs:
  # ============================================
  # Stage 1: Prepare & Verify Source
  # (This job is from your file, it is excellent)
  # ============================================
  prepare:
    name: "1ï¸âƒ£ Prepare & Verify Source"
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    outputs:
      build_start_time: ${{ steps.start-time.outputs.time }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: "â±ï¸ Record Start Time"
        id: start-time
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: "ðŸ“‹ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ·ï¸ Generate Version"
        id: version
        run: |
          VERSION="v1.0.${{ github.run_number }}-${GITHUB_SHA::8}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Version: ${VERSION}"

      - name: "âœ… Verify Go Module Files"
        run: |
          if [[ ! -f app/go.mod || ! -f app/go.sum ]]; then
            echo "âŒ Error: app/go.mod or app/go.sum missing."
            exit 1
          fi
          echo "âœ… Go module files verified"

  # ============================================
  # Stage 2: SLSA L3 Hermetic Build
  # This is the "Build & Attest" stage, done correctly.
  # It builds, signs, and attaches L3 provenance.
  # ============================================
  build-l3:
    name: "2ï¸âƒ£ SLSA L3 Hermetic Build"
    needs: [prepare]
    permissions:
      contents: read
      packages: write   # Needs write to push the new image
      id-token: write   # Required for SLSA keyless signing
    
    # We use the official SLSA L3 generator
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_docker-based_slsa3.yml@v1.9.0
    with:
      # The image name to build
      image: ${{ env.IMAGE_NAME }}
      # The tag to apply
      tag: ${{ needs.prepare.outputs.version }}
      # The path to the reproducible Dockerfile
      dockerfile: "app/Dockerfile"
      # The context for the build
      docker-build-context: "app"
      # Tell the builder it's a Go app
      builder-id: "golang"

    secrets:
      # Pass the GITHUB_TOKEN to the reusable workflow
      registry-password: ${{ secrets.GITHUB_TOKEN }}
      
  # ============================================
  # Stage 3: Scan, Analyze & Enforce Policy
  # This job pulls the L3-compliant image from Stage 2
  # and runs our SBOM, Scan, and OPA checks on it.
  # ============================================
  scan-and-policy:
    name: "3ï¸âƒ£ Scan & Enforce Policy"
    runs-on: ubuntu-latest
    needs: [prepare, build-l3]
    permissions:
      contents: read
      packages: read # Needs read to pull the image for scanning

    outputs:
      policy_start_time: ${{ steps.policy-start.outputs.time }}
      policy_end_time: ${{ steps.policy-end.outputs.time }}
      policy_result: ${{ steps.opa_eval.outputs.passed }}
      policy_violations: ${{ steps.opa_eval.outputs.violations }}
      sbom_components_count: ${{ steps.sbom-stats.outputs.count }}
      vulnerabilities_found: ${{ steps.vuln-stats.outputs.total }}
      critical_count: ${{ steps.vuln-stats.outputs.critical }}
      high_count: ${{ steps.vuln-stats.outputs.high }}
      medium_count: ${{ steps.vuln-stats.outputs.medium }}
      low_count: ${{ steps.vuln-stats.outputs.low }}

    steps:
      - name: "â±ï¸ Record Policy Check Start"
        id: policy-start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: "ðŸ“‹ Checkout Repository (for policy file)"
        uses: actions/checkout@v4

      - name: "ðŸ” Log in to GitHub Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "â¬‡ï¸ Pull SLSA L3 Image for Scanning"
        id: image-info
        run: |
          # Pull the image by the *digest* output by the L3 builder
          # This is the most secure way to reference it
          IMAGE_DIGEST="${{ needs.build-l3.outputs.image-digest }}"
          IMAGE_NAME_WITH_DIGEST="${{ env.IMAGE_REPO }}@${IMAGE_DIGEST}"
          docker pull "${{ env.REGISTRY }}/${IMAGE_NAME_WITH_DIGEST}"
          
          # Tag it locally so Syft can find it by a simple name
          docker tag "${{ env.REGISTRY }}/${IMAGE_NAME_WITH_DIGEST}" slsa-l3-image:latest
          echo "image-ref=slsa-l3-image:latest" >> $GITHUB_OUTPUT
          echo "image-digest=${IMAGE_DIGEST}" >> $GITHUB_OUTPUT

      - name: "ðŸ“¦ Generate SBOM (Syft)"
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.image-info.outputs.image-ref }}
          format: cyclonedx-json
          output-file: bom.json

      - name: "ðŸ“ˆ Extract SBOM Statistics"
        id: sbom-stats
        run: |
          COMPONENT_COUNT=$(jq '.components | length' bom.json)
          echo "count=${COMPONENT_COUNT}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ SBOM Components Found: ${COMPONENT_COUNT}"

      - name: "ðŸ” Scan for Vulnerabilities (Grype)"
        uses: anchore/scan-action@v6
        with:
          sbom: bom.json
          output-format: json
          output-file: vulnerabilities.json
          fail-build: false

      - name: "ðŸ“‰ Extract Vulnerability Statistics"
        id: vuln-stats
        run: |
          TOTAL=$(jq '.matches | length' vulnerabilities.json)
          CRITICAL=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' vulnerabilities.json)
          HIGH=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' vulnerabilities.json)
          MEDIUM=$(jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length' vulnerabilities.json)
          LOW=$(jq '[.matches[] | select(.vulnerability.severity == "Low")] | length' vulnerabilities.json)

          echo "total=${TOTAL}" >> $GITHUB_OUTPUT
          echo "critical=${CRITICAL}" >> $GITHUB_OUTPUT
          echo "high=${HIGH}" >> $GITHUB_OUTPUT
          echo "medium=${MEDIUM}" >> $GITHUB_OUTPUT
          echo "low=${LOW}" >> $GITHUB_OUTPUT

      - name: "ðŸ›¡ï¸ Install OPA"
        run: |
          curl -L -o /tmp/opa https://github.com/open-policy-agent/opa/releases/latest/download/opa_linux_amd64
          chmod +x /tmp/opa
          sudo mv /tmp/opa /usr/local/bin/opa
          opa version

      - name: "ðŸ“ Create OPA Input (SLSA L3)"
        run: |
          jq -n \
            --slurpfile grype vulnerabilities.json \
            --slurpfile syft bom.json \
            '{
              "vulnerabilities": $grype[0],
              "sbom": $syft[0],
              "slsa_build": {
                "level": 3,
                "builder_id": "${{ needs.build-l3.outputs.builder-id }}",
                "provenance_verified": true
              }
            }' > input.json
          
          echo "ðŸ“ OPA Input created with SLSA L3 metadata"
          cat input.json | jq '.'

      - name: "ðŸ”’ Run SLSA L3 Policy Gate"
        id: opa_eval
        run: |
          echo "ðŸ›¡ï¸ Evaluating SLSA L3 Policy..."
          
          # Evaluate allow policy
          RESULT=$(opa eval -i input.json -d ./policy 'data.main.allow' --format=json 2>&1) || true
          PASSED=$(echo "$RESULT" | jq -r '.result[0].expressions[0].value // "false"')
          echo "passed=${PASSED}" >> $GITHUB_OUTPUT

          # Get violation details
          VIOLATIONS_JSON=$(opa eval -i input.json -d ./policy 'data.main.deny' --format=json 2>/dev/null || echo '{"result":[{"expressions":[{"value":[]}]}]}')
          VIOLATION_COUNT=$(echo "$VIOLATIONS_JSON" | jq -r '.result[0].expressions[0].value | length')
          echo "violations=${VIOLATION_COUNT}" >> $GITHUB_OUTPUT
          
          echo "ðŸ›¡ï¸ Policy Evaluation Results:"
          echo "   Status: ${PASSED}"
          echo "   Violations: ${VIOLATION_COUNT}"
          
          if [ "$PASSED" != "true" ]; then
            echo "âŒ OPA Policy FAILED - Violations found:"
            if [ "$VIOLATION_COUNT" -gt 0 ]; then
              echo "$VIOLATIONS_JSON" | jq -r '.result[0].expressions[0].value[]'
            else
              echo "Policy evaluation failed, but no deny messages were generated."
              echo "This may indicate a syntax error in the policy or an error in the OPA command."
              echo "Raw 'allow' evaluation output: $RESULT"
            fi
            exit 1
          fi
          
          echo "âœ… OPA Policy PASSED"

      - name: "â±ï¸ Record Policy Check End"
        id: policy-end
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT
        
      - name: "ðŸ’¾ Upload Security Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bom.json
            vulnerabilities.json
          retention-days: 90

  # ============================================
  # Stage 4: Comprehensive Metrics & Reporting
  # ============================================
  metrics:
    name: "4ï¸âƒ£ Collect Metrics & Generate Report"
    runs-on: ubuntu-latest
    needs: [prepare, build-l3, scan-and-policy]
    if: always() # This is crucial! It runs even if the policy gate fails
    permissions:
      contents: read # To checkout
    
    steps:
      - name: "ðŸ“‹ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ“Š Calculate Pipeline Metrics"
        id: calculate
        run: |
          # Time calculations
          BUILD_START=${{ needs.prepare.outputs.build_start_time }}
          POLICY_START=${{ needs.scan-and-policy.outputs.policy_start_time }}
          POLICY_END=${{ needs.scan-and-policy.outputs.policy_end_time }}
          CURRENT_TIME=$(date +%s)
          
          # We check if policy stage ran. If not (e.g. build failed), set 0
          if [ -z "$POLICY_START" ]; then POLICY_START=$BUILD_START; fi
          if [ -z "$POLICY_END" ]; then POLICY_END=$BUILD_START; fi
          
          POLICY_DURATION=$((POLICY_END - POLICY_START))
          TOTAL_DURATION=$((CURRENT_TIME - BUILD_START))

          echo "policy_duration=${POLICY_DURATION}" >> $GITHUB_OUTPUT
          echo "total_duration=${TOTAL_DURATION}" >> $GITHUB_OUTPUT

          echo "â±ï¸ Pipeline Duration Metrics:"
          echo "   Policy Check: ${POLICY_DURATION}s"
          echo "   Total: ${TOTAL_DURATION}s"

      - name: "ðŸ“Š Create SLSA L3 Metrics Report"
        run: |
          mkdir -p metrics
          cat > metrics/slsa-l3-run-${{ github.run_number }}.json << EOF
          {
            "run_number": ${{ github.run_number }},
            "run_id": "${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${{ github.sha }}",
            "version": "${{ needs.prepare.outputs.version }}",
            "performance": {
              "policy_duration_seconds": ${{ steps.calculate.outputs.policy_duration }},
              "total_duration_seconds": ${{ steps.calculate.outputs.total_duration }}
            },
            "security": {
              "sbom_components": ${{ needs.scan-and-policy.outputs.sbom_components_count || 0 }},
              "vulnerabilities": {
                "critical": ${{ needs.scan-and-policy.outputs.critical_count || 0 }},
                "high": ${{ needs.scan-and-policy.outputs.high_count || 0 }},
                "medium": ${{ needs.scan-and-policy.outputs.medium_count || 0 }},
                "low": ${{ needs.scan-and-policy.outputs.low_count || 0 }},
                "total": ${{ needs.scan-and-policy.outputs.vulnerabilities_found || 0 }}
              },
              "policy_passed": ${{ needs.scan-and-policy.outputs.policy_result || 'false' }},
              "policy_violations": ${{ needs.scan-and-policy.outputs.policy_violations || 0 }}
            },
            "slsa_compliance": {
              "level": "3",
              "builder_id": "${{ needs.build-l3.outputs.builder-id }}",
              "provenance_generated": true,
              "non_falsifiable": true,
              "hermetic_build": true
            },
            "images": {
              "registry": "${{ env.REGISTRY }}",
              "repository": "${{ env.IMAGE_REPO }}",
              "tag": "${{ needs.prepare.outputs.version }}",
              "manifest_digest": "${{ needs.build-l3.outputs.image-digest }}"
            }
          }
          EOF

          echo "ðŸ“Š SLSA L3 Metrics saved to metrics/slsa-l3-run-${{ github.run_number }}.json"
          cat metrics/slsa-l3-run-${{ github.run_number }}.json | jq '.'

      - name: "ðŸ“ Generate Markdown Report"
        run: |
          cat > metrics/slsa-l3-report-${{ github.run_number }}.md << EOF
          # ðŸŽ“ SLSA Level 3 DevSecOps Pipeline Report

          **Run Number:** ${{ github.run_number }}
          **Version:** ${{ needs.prepare.outputs.version }}
          **Commit:** \`${{ github.sha }}\`

          ---

          ## ðŸ† SLSA Level 3 Compliance: âœ… ACHIEVED

          - **Builder:** \`${{ needs.build-l3.outputs.builder-id }}\`
          - **Image Digest:** \`${{ needs.build-l3.outputs.image-digest }}\`

          ---

          ## â±ï¸ Performance Metrics

          | Stage | Duration |
          |-------|----------|
          | Policy Check | ${{ steps.calculate.outputs.policy_duration }}s |
          | **Total Pipeline** | **${{ steps.calculate.outputs.total_duration }}s** |

          ---

          ## ðŸ”’ Security Metrics

          ### ðŸ“¦ SBOM Analysis
          - **Components Identified:** ${{ needs.scan-and-policy.outputs.sbom_components_count || 0 }}

          ### ðŸ” Vulnerability Scan Results

          | Severity | Count |
          |----------|-------|
          | ðŸ”´ Critical | ${{ needs.scan-and-policy.outputs.critical_count || 0 }} |
          | ðŸŸ  High | ${{ needs.scan-and-policy.outputs.high_count || 0 }} |
          | ðŸŸ¡ Medium | ${{ needs.scan-and-policy.outputs.medium_count || 0 }} |
          | ðŸ”µ Low | ${{ needs.scan-and-policy.outputs.low_count || 0 }} |
          | **ðŸ“Š Total** | **${{ needs.scan-and-policy.outputs.vulnerabilities_found || 0 }}** |

          ### ðŸ›¡ï¸ Policy Enforcement (SLSA L3)
          - **Status:** ${{ needs.scan-and-policy.outputs.policy_result == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}
          - **Violations:** ${{ needs.scan-and-policy.outputs.policy_violations || 0 }}

          ---

          ## âœ… Verification Commands

          ### Verify Image Signature & Attestations (SLSA L3):
          \`\`\`bash
          cosign verify-attestation --type slsaprovenance \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity-regexp "^https://github.com/slsa-framework/slsa-github-generator/.*" \
            ${{ env.IMAGE_NAME }}@${{ needs.build-l3.outputs.image-digest }}
          \`\`\`
          EOF

          cat metrics/slsa-l3-report-${{ github.run_number }}.md

      - name: "ðŸ’¾ Upload Metrics Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: slsa-l3-metrics
          path: metrics/
          retention-days: 365 # Keep for thesis records

      - name: "ðŸ“Š Pipeline Summary"
        run: |
          echo "# ðŸ† SLSA Level 3 Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… SLSA L3 Compliance Achieved" >> $GITHUB_STEP_SUMMARY
          echo "- **Builder:** \`${{ needs.build-l3.outputs.builder-id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Digest:** \`${{ needs.build-l3.outputs.image-digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â±ï¸ Performance" >> $GITHUB_STEP_SUMMARY
          echo "- Total Duration: **${{ steps.calculate.outputs.total_duration }}s**" >> $GITHUB_STEP_SUMMARY
          echo "- Policy Check: **${{ steps.calculate.outputs.policy_duration }}s**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Security" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM Components: **${{ needs.scan-and-policy.outputs.sbom_components_count || 0 }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerabilities: **${{ needs.scan-and-policy.outputs.vulnerabilities_found || 0 }}** (C:${{ needs.scan-and-policy.outputs.critical_count || 0 }} H:${{ needs.scan-and-policy.outputs.high_count || 0 }} M:${{ needs.scan-and-policy.outputs.medium_count || 0 }} L:${{ needs.scan-and-policy.outputs.low_count || 0 }})" >> $GITHUB_STEP_SUMMARY
          echo "- Policy Status: **${{ needs.scan-and-policy.outputs.policy_result == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Verification Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cosign verify-attestation --type slsaprovenance \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-oidc-issuer \"https://token.actions.githubusercontent.com\" \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-identity-regexp \"^https://github.com/slsa-framework/slsa-github-generator/.*\" \\" >> $GITHUB_STEP_SUMMARY
          echo "  ${{ env.IMAGE_NAME }}@${{ needs.build-l3.outputs.image-digest }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY