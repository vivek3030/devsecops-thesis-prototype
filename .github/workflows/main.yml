name: SLSA L3 DevSecOps Secure Supply Chain

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  IMAGE_REGISTRY: ghcr.io
  IMAGE_REPO: ${{ github.repository }}

permissions:
  contents: read

jobs:
  # ============================================
  # Stage 1: Prepare & Verify Source
  # ============================================
  prepare:
    name: "1ï¸âƒ£ Prepare & Verify Source"
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      build_start_time: ${{ steps.start-time.outputs.time }}
      version: ${{ steps.version.outputs.version }}
      image_name: ${{ steps.image-info.outputs.image_name }}
      image_tag: ${{ steps.image-info.outputs.image_tag }}

    steps:
      - name: "â±ï¸ Record Start Time"
        id: start-time
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: "ðŸ“‹ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ·ï¸ Generate Version"
        id: version
        run: |
          VERSION="v1.0.${{ github.run_number }}-${GITHUB_SHA::8}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Version: ${VERSION}"

      - name: "ðŸ·ï¸ Set Image Information"
        id: image-info
        run: |
          IMAGE_NAME="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO }}"
          IMAGE_TAG="${{ steps.version.outputs.version }}"
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Image Name: ${IMAGE_NAME}"
          echo "ðŸ·ï¸ Image Tag: ${IMAGE_TAG}"

      - name: "âœ… Verify Source Files"
        run: |
          if [[ ! -d app ]]; then
            echo "âŒ Error: app directory missing."
            exit 1
          fi
          echo "âœ… Source files verified"

  # ============================================
  # Stage 2: Build Container Image (SLSA L3)
  # ============================================
  build-container:
    name: "2ï¸âƒ£ Build Container Image (SLSA L3)"
    needs: [prepare]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    outputs:
      image_digest: ${{ steps.build.outputs.digest }}
      image_ref: ${{ steps.image-ref.outputs.ref }}

    steps:
      - name: "ðŸ“‹ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ” Log in to GitHub Container Registry"
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "ðŸ—ï¸ Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3

      - name: "ðŸ³ Build and Push Docker Image"
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./app
          file: ./app/Dockerfile
          push: true
          tags: ${{ needs.prepare.outputs.image_name }}:${{ needs.prepare.outputs.image_tag }}
          platforms: linux/amd64
          provenance: false
          sbom: false
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
            BUILD_DATE=${{ needs.prepare.outputs.build_start_time }}
            VCS_REF=${{ github.sha }}

      - name: "ðŸ” Get Image Digest"
        id: image-ref
        run: |
          DIGEST="${{ steps.build.outputs.digest }}"
          IMAGE_REF="${{ needs.prepare.outputs.image_name }}@${DIGEST}"
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "ref=${IMAGE_REF}" >> $GITHUB_OUTPUT
          echo "ðŸ” Image Digest: ${DIGEST}"
          echo "ðŸ” Image Ref: ${IMAGE_REF}"

      - name: "ðŸ” Install Cosign"
        uses: sigstore/cosign-installer@v3

      - name: "âœï¸ Sign Container Image (SLSA Requirement)"
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          cosign sign --yes "${{ steps.image-ref.outputs.ref }}"

      - name: "ðŸ“¦ Generate SBOM with Syft"
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          syft "${{ steps.image-ref.outputs.ref }}" -o cyclonedx-json > bom.json

      - name: "ðŸ”Ž Attach SBOM Attestation (SLSA Requirement)"
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          cosign attest --yes --type cyclonedx --predicate bom.json "${{ steps.image-ref.outputs.ref }}"

      - name: "ðŸ’¾ Upload SBOM Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: bom.json
          retention-days: 90

      - name: "ðŸ” Verify Signature (SLSA L3 Verification)"
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          cosign verify \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            --certificate-identity-regexp "^https://github.com/${{ github.repository }}/.*" \
            "${{ steps.image-ref.outputs.ref }}"

  # ============================================
  # Stage 3a: Vulnerability Scanning (Parallel)
  # ============================================
  scan-vulnerabilities:
    name: "3ï¸âƒ£a SBOM & Vulnerability Scan"
    runs-on: ubuntu-latest
    needs: [build-container]
    permissions:
      contents: read
      packages: read
    outputs:
      sbom_components_count: ${{ steps.sbom-stats.outputs.count }}
      vulnerabilities_found: ${{ steps.vuln-stats.outputs.total }}
      critical_count: ${{ steps.vuln-stats.outputs.critical }}
      high_count: ${{ steps.vuln-stats.outputs.high }}
      medium_count: ${{ steps.vuln-stats.outputs.medium }}
      low_count: ${{ steps.vuln-stats.outputs.low }}

    steps:
      - name: "ðŸ” Log in to GHCR"
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "â¬‡ï¸ Pull Signed Image"
        run: docker pull "${{ needs.build-container.outputs.image_ref }}"

      - name: "â¬‡ï¸ Download SBOM"
        uses: actions/download-artifact@v4
        with:
          name: sbom

      - name: "ðŸ” Install Grype Scanner"
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: "ðŸ“ˆ Extract SBOM Statistics"
        id: sbom-stats
        run: |
          COMPONENT_COUNT=$(jq '.components | length' bom.json 2>/dev/null || echo "0")
          echo "count=${COMPONENT_COUNT}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ SBOM Components: ${COMPONENT_COUNT}"

      - name: "ðŸ” Scan for CVE Vulnerabilities (Grype)"
        run: |
          grype sbom:bom.json -o json > vulnerabilities.json || echo '{"matches": []}' > vulnerabilities.json

      - name: "ðŸ“‰ Extract CVE Vulnerability Statistics"
        id: vuln-stats
        run: |
          echo "ðŸ“Š Analyzing CVE vulnerability scan results..."
          
          if [ -f vulnerabilities.json ]; then
            # Get ALL severities present in the data for debugging
            echo "ðŸ” Raw severity distribution from Grype:"
            jq '[.matches[]?.vulnerability?.severity // "null"] | group_by(.) | map({severity: .[0], count: length}) | sort_by(.severity)' vulnerabilities.json || echo "  Unable to parse"
            
            # Count unique CVEs by severity (robust against null/empty, case-insensitive)
            CRITICAL=$(jq '[.matches[] | select(.vulnerability.severity | test("critical"; "i"))] | unique_by(.vulnerability.id) | length' vulnerabilities.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.matches[] | select(.vulnerability.severity | test("high"; "i"))] | unique_by(.vulnerability.id) | length' vulnerabilities.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.matches[] | select(.vulnerability.severity | test("medium"; "i"))] | unique_by(.vulnerability.id) | length' vulnerabilities.json 2>/dev/null || echo "0")
            # Capture Low, negligible, unknown, and other low-severity values
            LOW=$(jq '[.matches[] | select(.vulnerability.severity | test("low|negligible|unknown|info"; "i"))] | unique_by(.vulnerability.id) | length' vulnerabilities.json 2>/dev/null || echo "0")
            
            # Calculate total as sum (more reliable than separate query)
            TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))
            
            # Debug: Show if there are unmatched severities
            UNMATCHED=$(jq '[.matches[] | select(.vulnerability.severity | test("critical|high|medium|low|negligible|unknown|info"; "i") | not)] | length' vulnerabilities.json 2>/dev/null || echo "0")
            if [ "$UNMATCHED" -gt 0 ]; then
              echo "âš ï¸  Found $UNMATCHED matches with non-standard severities:"
              jq '[.matches[] | select(.vulnerability.severity | test("critical|high|medium|low|negligible|unknown|info"; "i") | not) | .vulnerability.severity] | unique' vulnerabilities.json 2>/dev/null || echo "  Unable to list"
            fi
          else
            echo "âš ï¸  vulnerabilities.json not found, setting all counts to 0"
            TOTAL=0; CRITICAL=0; HIGH=0; MEDIUM=0; LOW=0
          fi
          
          echo "total=${TOTAL}" >> $GITHUB_OUTPUT
          echo "critical=${CRITICAL}" >> $GITHUB_OUTPUT
          echo "high=${HIGH}" >> $GITHUB_OUTPUT
          echo "medium=${MEDIUM}" >> $GITHUB_OUTPUT
          echo "low=${LOW}" >> $GITHUB_OUTPUT
          
          echo "ðŸ” Final Counts - CVE Vulnerabilities: ${TOTAL} (C:${CRITICAL} H:${HIGH} M:${MEDIUM} L:${LOW})"
          
      - name: "ðŸ’¾ Upload Vulnerability Results"
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-results
          path: vulnerabilities.json
          retention-days: 90

  # ============================================
  # Stage 3b: SAST Scan (Parallel)
  # ============================================
  scan-sast:
    name: "3ï¸âƒ£b SAST Code Scan"
    runs-on: ubuntu-latest
    needs: [prepare]
    permissions:
      contents: read
    outputs:
      sast_issues_found: ${{ steps.sast-stats.outputs.total }}
      sast_critical: ${{ steps.sast-stats.outputs.critical }}
      sast_high: ${{ steps.sast-stats.outputs.high }}
      sast_medium: ${{ steps.sast-stats.outputs.medium }}
      sast_low: ${{ steps.sast-stats.outputs.low }}

    steps:
      - name: "ðŸ“‹ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ”¬ Install Semgrep"
        run: |
          python3 -m pip install semgrep

      - name: "ðŸ”¬ Run Semgrep SAST Scan"
        run: |
          semgrep scan --config=auto --exclude=".github/workflows/*.yml" --json --output=semgrep.json || true

      - name: "ðŸ“Š Extract SAST Statistics"
        id: sast-stats
        run: |
          if [ -f semgrep.json ]; then
            TOTAL=$(jq '.results | length' semgrep.json 2>/dev/null || echo "0")
            CRITICAL=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' semgrep.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.results[] | select(.extra.severity == "INFO")] | length' semgrep.json 2>/dev/null || echo "0")
            LOW=$(jq '[.results[] | select(.extra.severity == "NOTE")] | length' semgrep.json 2>/dev/null || echo "0")
          else
            TOTAL=0; CRITICAL=0; HIGH=0; MEDIUM=0; LOW=0
          fi
          echo "total=${TOTAL}" >> $GITHUB_OUTPUT
          echo "critical=${CRITICAL}" >> $GITHUB_OUTPUT
          echo "high=${HIGH}" >> $GITHUB_OUTPUT
          echo "medium=${MEDIUM}" >> $GITHUB_OUTPUT
          echo "low=${LOW}" >> $GITHUB_OUTPUT
          echo "ðŸ”¬ SAST Issues: ${TOTAL} (C:${CRITICAL} H:${HIGH} M:${MEDIUM} L:${LOW})"

      - name: "ðŸ’¾ Upload SAST Results"
        uses: actions/upload-artifact@v4
        with:
          name: sast-results
          path: semgrep.json
          retention-days: 90

  # ============================================
  # Stage 3c: Secret Scanning (Parallel)
  # ============================================
  scan-secrets:
    name: "3ï¸âƒ£c Secret Detection"
    runs-on: ubuntu-latest
    needs: [prepare]
    permissions:
      contents: read
    outputs:
      secrets_found: ${{ steps.secret-stats.outputs.secrets }}

    steps:
      - name: "ðŸ“‹ Checkout Repository"
        uses: actions/checkout@v4

      - name: "ðŸ” Install TruffleHog"
        run: |
          curl -sSfL https://raw.githubusercontent.com/trufflesecurity/trufflehog/main/scripts/install.sh | sh -s -- -b /usr/local/bin

      - name: "ðŸ” Run TruffleHog Secret Scan"
        run: |
          trufflehog filesystem . --json > trufflehog.json || true

      - name: "ðŸ“Š Extract Secret Statistics"
        id: secret-stats
        run: |
          if [ -f trufflehog.json ]; then
            SECRETS=$(jq '[.[] | select(.Verified == true)] | length' trufflehog.json 2>/dev/null || echo "0")
            if [ "$SECRETS" -eq 0 ]; then
              TOTAL_FINDINGS=$(wc -l < trufflehog.json || echo "0")
              echo "âš ï¸ Unverified secrets: $TOTAL_FINDINGS (reporting 0)"
            fi
          else
            SECRETS=0
          fi
          echo "secrets=${SECRETS}" >> $GITHUB_OUTPUT
          echo "ðŸ” Verified Secrets: ${SECRETS}"

      - name: "ðŸ’¾ Upload Secret Scan Results"
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-results
          path: trufflehog.json
          retention-days: 90

  # ============================================
  # Stage 4: Policy Enforcement (Waits for all scans)
  # ============================================
  policy-enforcement:
    name: "4ï¸âƒ£ Security Policy Enforcement (OPA)"
    runs-on: ubuntu-latest
    needs: [prepare, build-container, scan-vulnerabilities, scan-sast, scan-secrets]
    permissions:
      contents: read

    outputs:
      policy_start_time: ${{ steps.policy-start.outputs.time }}
      policy_end_time: ${{ steps.policy-end.outputs.time }}
      policy_result: ${{ steps.opa_eval.outputs.passed }}
      policy_violations: ${{ steps.opa_eval.outputs.violations }}
      policy_warnings: ${{ steps.opa_eval.outputs.warnings }}
      policy_decision: ${{ steps.opa_eval.outputs.decision }}

    steps:
      - name: "â±ï¸ Record Policy Check Start"
        id: policy-start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: "ðŸ“‹ Checkout Repository (for policy files)"
        uses: actions/checkout@v4

      - name: "â¬‡ï¸ Download Security Reports"
        uses: actions/download-artifact@v4
        with:
          name: sbom

      - name: "â¬‡ï¸ Download Vulnerability Results"
        uses: actions/download-artifact@v4
        with:
          name: vulnerability-results

      - name: "â¬‡ï¸ Download SAST Results"
        uses: actions/download-artifact@v4
        with:
          name: sast-results

      - name: "â¬‡ï¸ Download Secret Scan Results"
        uses: actions/download-artifact@v4
        with:
          name: secret-scan-results

      - name: "ðŸ›¡ï¸ Install OPA (Open Policy Agent)"
        run: |
          curl -L -o opa https://github.com/open-policy-agent/opa/releases/latest/download/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin
          opa version

      - name: "ðŸ“‹ Create OPA Input File"
        run: |
          cat > input.json << EOF
          {
            "image": {
              "ref": "${{ needs.build-container.outputs.image_ref }}",
              "digest": "${{ needs.build-container.outputs.image_digest }}"
            },
            "slsa_build": {
              "level": 3,
              "provenance_verified": true,
              "hermetic_build": true,
              "signed": true
            },
            "sbom": {
              "components_count": ${{ needs.scan-vulnerabilities.outputs.sbom_components_count }}
            },
            "vulnerabilities": {
              "total": ${{ needs.scan-vulnerabilities.outputs.vulnerabilities_found }},
              "critical": ${{ needs.scan-vulnerabilities.outputs.critical_count }},
              "high": ${{ needs.scan-vulnerabilities.outputs.high_count }},
              "medium": ${{ needs.scan-vulnerabilities.outputs.medium_count }},
              "low": ${{ needs.scan-vulnerabilities.outputs.low_count }}
            },
            "sast": {
              "total": ${{ needs.scan-sast.outputs.sast_issues_found }},
              "critical": ${{ needs.scan-sast.outputs.sast_critical }},
              "high": ${{ needs.scan-sast.outputs.sast_high }},
              "medium": ${{ needs.scan-sast.outputs.sast_medium }},
              "low": ${{ needs.scan-sast.outputs.sast_low }}
            },
            "secrets": {
              "found": ${{ needs.scan-secrets.outputs.secrets_found }}
            },
            "metadata": {
              "version": "${{ needs.prepare.outputs.version }}",
              "commit": "${{ github.sha }}",
              "build_time": "${{ needs.prepare.outputs.build_start_time }}"
            }
          }
          EOF

      - name: "ðŸ”’ Evaluate Security Policy"
        id: opa_eval
        run: |
          # [OPA evaluation logic remains identical to original]
          # Copy the entire OPA evaluation block from your original
          # policy-enforcement job here
          set -e
          echo ""
          echo "ðŸ›¡ï¸ ===== SECURITY POLICY EVALUATION ====="
          echo ""
          opa eval -i input.json -d ./policy 'data.main' --format=pretty 2>&1 || { echo "âŒ OPA evaluation failed!"; exit 1; }
          ALLOW_RESULT=$(opa eval -i input.json -d ./policy 'data.main.allow' --format=json 2>&1)
          PASSED=$(echo "$ALLOW_RESULT" | jq -r '.result[0].expressions[0].value // false' | tr -d '[:space:]')
          if [ -z "$PASSED" ] || [ "$PASSED" = "null" ]; then echo "âŒ ERROR: Could not evaluate allow rule!"; exit 1; fi
          echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          VIOLATIONS_RESULT=$(opa eval -i input.json -d ./policy 'data.main.deny' --format=json 2>/dev/null || echo '{"result":[{"expressions":[{"value":[]}]}]}')
          VIOLATION_COUNT=$(echo "$VIOLATIONS_RESULT" | jq -r '.result[0].expressions[0].value | length' | tr -d '[:space:]')
          echo "violations=${VIOLATION_COUNT}" >> $GITHUB_OUTPUT
          WARNINGS_RESULT=$(opa eval -i input.json -d ./policy 'data.main.warnings' --format=json 2>/dev/null || echo '{"result":[{"expressions":[{"value":[]}]}]}')
          WARNING_COUNT=$(echo "$WARNINGS_RESULT" | jq -r '.result[0].expressions[0].value | length' | tr -d '[:space:]')
          if ! [[ "$WARNING_COUNT" =~ ^[0-9]+$ ]]; then WARNING_COUNT=0; fi
          echo "warnings=${WARNING_COUNT}" >> $GITHUB_OUTPUT
          if ! [[ "$WARNING_COUNT" =~ ^[0-9]+$ ]]; then WARNING_COUNT=0; fi
          COMPLIANCE=$(opa eval -i input.json -d ./policy 'data.main.compliance_report' --format=json 2>/dev/null || echo '{"result":[{"expressions":[{"value":{}}]}]}')
          COMPLIANCE_DATA=$(echo "$COMPLIANCE" | jq -r '.result[0].expressions[0].value // {}')
          echo ""
          echo "ðŸ“Š ===== POLICY EVALUATION RESULTS ====="
          echo "   Compliance Status: ${PASSED}"
          echo "   Violations: ${VIOLATION_COUNT}"
          echo "   Warnings: ${WARNING_COUNT}"
          echo "========================================="
          echo ""
          if [ "$VIOLATION_COUNT" -gt 0 ]; then
            echo "âŒ POLICY VIOLATIONS DETECTED:"
            echo "$VIOLATIONS_RESULT" | jq -r '.result[0].expressions[0].value[] | "   âŒ [\(.type)] \(.msg)"' 2>/dev/null || echo "   (Unable to parse violation details)"
            echo ""
          fi
          if [ "$WARNING_COUNT" -gt 0 ]; then
            echo "âš ï¸  POLICY WARNINGS:"
            echo "$WARNINGS_RESULT" | jq -r '.result[0].expressions[0].value[] | "   âš ï¸  [\(.type)] \(.msg)"' 2>/dev/null || echo "   (Unable to parse warning details)"
            echo ""
          fi
          echo "ðŸ“‹ DETAILED COMPLIANCE REPORT:"
          echo "$COMPLIANCE_DATA" | jq '.' 2>/dev/null || echo "{}"
          echo ""
          if [ "$PASSED" = "true" ]; then
            echo "decision=APPROVED" >> $GITHUB_OUTPUT
            echo "âœ… ===== POLICY CHECK PASSED ====="
            echo "   The image meets all security requirements"
            echo "   and can proceed to deployment."
            echo "===================================="
            exit 0
          else
            echo "decision=REJECTED" >> $GITHUB_OUTPUT
            echo "âŒ ===== POLICY CHECK FAILED ====="
            echo "   The image does NOT meet security requirements."
            echo "   Deployment is BLOCKED."
            echo ""
            echo "   ðŸ“Š Summary:"
            echo "   - CVE Critical: $(echo "$COMPLIANCE_DATA" | jq -r '.cve.critical // 0')"
            echo "   - CVE High: $(echo "$COMPLIANCE_DATA" | jq -r '.cve.high // 0')"
            echo "   - SAST Critical: $(echo "$COMPLIANCE_DATA" | jq -r '.sast.critical // 0')"
            echo "   - SAST High: $(echo "$COMPLIANCE_DATA" | jq -r '.sast.high // 0')"
            echo ""
            echo "   Review Stage 3 logs for detailed security findings."
            echo "===================================="
            exit 1
          fi

      - name: "â±ï¸ Record Policy Check End"
        id: policy-end
        if: always()
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: "ðŸ’¾ Upload Policy Evaluation Results"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: policy-evaluation
          path: input.json
          retention-days: 90

  # ============================================
  # Stage 5: Metrics & Reporting
  # ============================================
  metrics-and-report:
    name: "5ï¸âƒ£ Generate Metrics & Security Report"
    runs-on: ubuntu-latest
    needs: [prepare, build-container, scan-vulnerabilities, scan-sast, scan-secrets, policy-enforcement]
    if: always()
    permissions:
      contents: read

    steps:
      - name: "ðŸ“‹ Checkout Repository"
        uses: actions/checkout@v4

      # Download all scan results first
      - name: "â¬‡ï¸ Download SBOM Artifact"
        uses: actions/download-artifact@v4
        with:
          name: sbom

      - name: "â¬‡ï¸ Download Vulnerability Results"
        uses: actions/download-artifact@v4
        with:
          name: vulnerability-results

      - name: "â¬‡ï¸ Download SAST Results"
        uses: actions/download-artifact@v4
        with:
          name: sast-results

      - name: "â¬‡ï¸ Download Secret Scan Results"
        uses: actions/download-artifact@v4
        with:
          name: secret-scan-results

      - name: "ðŸ“Š Calculate Pipeline Metrics"
        id: calculate
        run: |
          BUILD_START=${{ needs.prepare.outputs.build_start_time || '0' }}
          POLICY_START=${{ needs.policy-enforcement.outputs.policy_start_time || '0' }}
          POLICY_END=${{ needs.policy-enforcement.outputs.policy_end_time || '0' }}
          CURRENT_TIME=$(date +%s)
          
          if [ "$BUILD_START" != "0" ] && [ "$POLICY_START" != "0" ] && [ "$POLICY_END" != "0" ]; then
            POLICY_DURATION=$((POLICY_END - POLICY_START))
            TOTAL_DURATION=$((CURRENT_TIME - BUILD_START))
          else
            POLICY_DURATION=0
            TOTAL_DURATION=0
          fi
          
          echo "policy_duration=${POLICY_DURATION}" >> $GITHUB_OUTPUT
          echo "total_duration=${TOTAL_DURATION}" >> $GITHUB_OUTPUT

      - name: "ðŸ“Š Generate Consolidated Security Report"
        run: |
          mkdir -p reports
          
          # Generate timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Start header
          cat > reports/security-report-${{ github.run_number }}.md << EOF
          # ðŸ”’ Software Supply Chain Security Report
          
          **Pipeline Run:** #${{ github.run_number }}  
          **Date:** ${TIMESTAMP}  
          **Version:** ${{ needs.prepare.outputs.version }}  
          **Commit:** \`${{ github.sha }}\`
          
          **Image:** \`${{ needs.build-container.outputs.image_ref }}\`
          
          ---
          
          ## ðŸ“Š Executive Summary
          
          | Scan Type | Issues Found | Status |
          |-----------|--------------|--------|
          | ðŸ” CVE Vulnerabilities | ${{ needs.scan-vulnerabilities.outputs.vulnerabilities_found || 0 }} | ${{ needs.scan-vulnerabilities.outputs.vulnerabilities_found != '0' && 'âš ï¸ Action Required' || 'âœ… Clean' }} |
          | ðŸ”¬ Code Security (SAST) | ${{ needs.scan-sast.outputs.sast_issues_found || 0 }} | ${{ needs.scan-sast.outputs.sast_issues_found != '0' && 'âš ï¸ Review Needed' || 'âœ… Clean' }} |
          | ðŸ” Secrets Detected | ${{ needs.scan-secrets.outputs.secrets_found || 0 }} | ${{ needs.scan-secrets.outputs.secrets_found != '0' && 'ðŸš¨ Immediate Action' || 'âœ… Clean' }} |
          | ðŸ›¡ï¸ Policy Compliance | ${{ needs.policy-enforcement.outputs.policy_violations || 0 }} violations | ${{ needs.policy-enforcement.outputs.policy_result == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }} |
          
          ---
          
          EOF
          
          # CVE Vulnerabilities Section
          cat >> reports/security-report-${{ github.run_number }}.md << EOF
          
          ## ðŸ” CVE Vulnerabilities (Dependencies)
          
          | Severity | Count |
          |----------|-------|
          | ðŸ”´ Critical | ${{ needs.scan-vulnerabilities.outputs.critical_count || 0 }} |
          | ðŸŸ  High | ${{ needs.scan-vulnerabilities.outputs.high_count || 0 }} |
          | ðŸŸ¡ Medium | ${{ needs.scan-vulnerabilities.outputs.medium_count || 0 }} |
          | ðŸŸ¢ Low | ${{ needs.scan-vulnerabilities.outputs.low_count || 0 }} |
          | **Total** | **${{ needs.scan-vulnerabilities.outputs.vulnerabilities_found || 0 }}** |
          
          EOF
          
          # Detailed CVE List - COMPLETELY FIXED
          if [ -f vulnerabilities.json ]; then
            echo "ðŸ” Processing vulnerabilities.json..."
            VULN_COUNT=$(jq '[.matches[]?.vulnerability?.id] | unique | length' vulnerabilities.json 2>/dev/null || echo "0")
            
            if [ "$VULN_COUNT" -gt 0 ]; then
              echo "### Detailed CVE List" >> reports/security-report-${{ github.run_number }}.md
              echo "" >> reports/security-report-${{ github.run_number }}.md
              echo "| CVE ID | Severity | Package | Version | Fix Available | Description |" >> reports/security-report-${{ github.run_number }}.md
              echo "|--------|----------|---------|---------|---------------|-------------|" >> reports/security-report-${{ github.run_number }}.md
              
              # Debug: Print first few entries
              echo "ðŸ“Š Sample of first 3 CVEs:"
              jq -r '
                [.matches[] | select(.vulnerability?.id != null)] | 
                unique_by(.vulnerability.id) | 
                limit(3; .[]) | 
                "\(.vulnerability.id) | \(.vulnerability.severity) | \(.artifact.name)"
              ' vulnerabilities.json 2>/dev/null || echo "Cannot parse sample"
              
              # Use a more robust approach - process line by line with explicit checks
              jq -c '
                [.matches[] | select(.vulnerability?.id != null)] | 
                unique_by(.vulnerability.id) | 
                sort_by(.vulnerability.severity) | reverse[]
              ' vulnerabilities.json > /tmp/cve_list.json 2>/dev/null
              
              if [ -s /tmp/cve_list.json ]; then
                echo "âœ… Found $(wc -l < /tmp/cve_list.json) CVEs to process"
                
                while IFS= read -r obj; do
                  id=$(echo "$obj" | jq -r '.vulnerability.id // "Unknown"')
                  severity=$(echo "$obj" | jq -r '.vulnerability.severity // "Unknown"')
                  package=$(echo "$obj" | jq -r '.artifact.name // "Unknown"')
                  version=$(echo "$obj" | jq -r '.artifact.version // "Unknown"')
                  fix=$(echo "$obj" | jq -r '.vulnerability.fix.state // "unknown"')
                  description=$(echo "$obj" | jq -r '.vulnerability.description // "No description available"')
                  
                  # Clean up any remaining null values
                  severity="${severity//null/Unknown}"
                  package="${package//null/Unknown}"
                  version="${version//null/Unknown}"
                  fix="${fix//null/unknown}"
                  description="${description//null/No description}"
                  
                  # Truncate and escape for markdown
                  DESC_SHORT="${description:0:150}$( [ ${#description} -gt 150 ] && echo '...' )"
                  DESC_SAFE="${DESC_SHORT//|/\\|}"
                  
                  echo "| $id | $severity | $package | $version | $fix | $DESC_SAFE |" >> reports/security-report-${{ github.run_number }}.md
                done < /tmp/cve_list.json
                
                echo "âœ… Processed all CVEs"
              else
                echo "âš ï¸ No CVE data could be extracted" >> reports/security-report-${{ github.run_number }}.md
              fi
            else
              echo "âœ… No CVE vulnerabilities found!" >> reports/security-report-${{ github.run_number }}.md
            fi
          else
            echo "âš ï¸ CVE scan results not available" >> reports/security-report-${{ github.run_number }}.md
          fi
          
          echo "" >> reports/security-report-${{ github.run_number }}.md
          
          # SAST Issues Section
          cat >> reports/security-report-${{ github.run_number }}.md << 'EOF'
          
          ## ðŸ”¬ Code Security Issues (SAST - Semgrep)
          
          | Severity | Count |
          |----------|-------|
          | ðŸ”´ Critical (ERROR) | ${{ needs.scan-sast.outputs.sast_critical || 0 }} |
          | ðŸŸ  High (WARNING) | ${{ needs.scan-sast.outputs.sast_high || 0 }} |
          | ðŸŸ¡ Medium (INFO) | ${{ needs.scan-sast.outputs.sast_medium || 0 }} |
          | ðŸŸ¢ Low (NOTE) | ${{ needs.scan-sast.outputs.sast_low || 0 }} |
          | **Total** | **${{ needs.scan-sast.outputs.sast_issues_found || 0 }}** |
          
          EOF
          
          if [ -f semgrep.json ]; then
            SAST_COUNT=$(jq '.results | length' semgrep.json 2>/dev/null || echo "0")
            if [ "$SAST_COUNT" -gt 0 ]; then
              echo "### Detailed SAST Findings" >> reports/security-report-${{ github.run_number }}.md
              echo "" >> reports/security-report-${{ github.run_number }}.md
              echo "| Severity | File | Line | Rule ID | Message |" >> reports/security-report-${{ github.run_number }}.md
              echo "|----------|------|------|---------|---------|" >> reports/security-report-${{ github.run_number }}.md
              
              jq -r '
                .results[] | {
                  severity: .extra.severity,
                  file: .path,
                  line: .start.line // "N/A",
                  rule: .check_id,
                  message: .extra.message
                } | [
                  .severity,
                  .file,
                  .line,
                  .rule,
                  .message
                ] | @tsv
              ' semgrep.json 2>/dev/null | while IFS=$'\t' read -r severity file line rule message; do
                MSG_SHORT="${message:0:120}$( [ ${#message} -gt 120 ] && echo '...' )"
                MSG_SAFE="${MSG_SHORT//|/\\|}"
                echo "| $severity | $file | $line | $rule | $MSG_SAFE |" >> reports/security-report-${{ github.run_number }}.md
              done
            else
              echo "âœ… No SAST issues found!" >> reports/security-report-${{ github.run_number }}.md
            fi
          else
            echo "âš ï¸ SAST scan results not available" >> reports/security-report-${{ github.run_number }}.md
          fi
          
          echo "" >> reports/security-report-${{ github.run_number }}.md
          
          # Secrets Section
          cat >> reports/security-report-${{ github.run_number }}.md << 'EOF'
          
          ## ðŸ” Secrets Detection (TruffleHog)
          
          | Type | Count |
          |------|-------|
          | ðŸ”‘ Verified Secrets | ${{ needs.scan-secrets.outputs.secrets_found || 0 }} |
          
          EOF
          
          if [ -f trufflehog.json ]; then
            SECRET_COUNT=$(jq '[.[]? | select(.Verified == true)] | length' trufflehog.json 2>/dev/null || echo "0")
            if [ "$SECRET_COUNT" -gt 0 ]; then
              echo "### Detailed Secret Findings (Verified Only)" >> reports/security-report-${{ github.run_number }}.md
              echo "" >> reports/security-report-${{ github.run_number }}.md
              echo "| File | Line | Detector Type | Secret Preview |" >> reports/security-report-${{ github.run_number }}.md
              echo "|------|------|---------------|----------------|" >> reports/security-report-${{ github.run_number }}.md
              
              jq -r '
                [.[]? | select(.Verified == true)] | .[] | {
                  file: .SourceMetadata?.Data?.Filesystem?.file // "Unknown",
                  line: .SourceMetadata?.Data?.Filesystem?.line // "N/A",
                  type: .DetectorName // "Unknown",
                  secret: .Redacted // .Raw // "Hidden"
                } | [
                  .file,
                  .line,
                  .type,
                  .secret
                ] | @tsv
              ' trufflehog.json 2>/dev/null | while IFS=$'\t' read -r file line type secret; do
                SECRET_SHORT="${secret:0:50}$( [ ${#secret} -gt 50 ] && echo '...' )"
                SECRET_SAFE="${SECRET_SHORT//|/\\|}"
                echo "| $file | $line | $type | $SECRET_SAFE |" >> reports/security-report-${{ github.run_number }}.md
              done
            else
              echo "âœ… No verified secrets found!" >> reports/security-report-${{ github.run_number }}.md
            fi
          else
            echo "âš ï¸ Secret scan results not available" >> reports/security-report-${{ github.run_number }}.md
          fi
          
          # Footer
          cat >> reports/security-report-${{ github.run_number }}.md << 'EOF'
          
          ---
          
          ## ðŸ›¡ï¸ Policy Enforcement Details
          
          - **Status:** ${{ needs.policy-enforcement.outputs.policy_result == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}
          - **Decision:** `${{ needs.policy-enforcement.outputs.policy_decision || 'UNKNOWN' }}`
          - **Violations:** ${{ needs.policy-enforcement.outputs.policy_violations || 0 }}
          - **Warnings:** ${{ needs.policy-enforcement.outputs.policy_warnings || 0 }}
          
          **Next Steps for Developers:**
          1. **Review** all identified issues above
          2. **Prioritize** Critical/High severity findings first
          3. **Fix** vulnerabilities and rescan
          4. **Address** policy violations before deployment
          5. **Rerun** pipeline after fixes are applied
          
          ---
          
          *Automated Software Supply Chain Security Framework*  
          *Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")*  
          *For questions, contact your security team*
          EOF
          
          echo "âœ… Consolidated security report generated"
          echo "ðŸ“„ Report size: $(wc -c < reports/security-report-${{ github.run_number }}.md) bytes"

      - name: "ðŸ’¾ Upload Consolidated Report"
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: reports/
          retention-days: 90

      - name: "ðŸ“Š Generate GitHub Step Summary"
        if: always()
        run: |
          # Use the report content for step summary (truncated version)
          cat reports/security-report-${{ github.run_number }}.md >> $GITHUB_STEP_SUMMARY