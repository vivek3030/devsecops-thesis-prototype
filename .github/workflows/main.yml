name: DevSecOps Secure Supply Chain with Metrics

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_REPO: ${{ github.repository }}

jobs:
  build:
    name: 1 - Build and Analyze
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.set-image.outputs.image }}
      build_start_time: ${{ steps.start-time.outputs.time }}
      build_end_time: ${{ steps.end-time.outputs.time }}
      sbom_components_count: ${{ steps.sbom-stats.outputs.count }}
      vulnerabilities_found: ${{ steps.vuln-stats.outputs.total }}
      critical_count: ${{ steps.vuln-stats.outputs.critical }}
      high_count: ${{ steps.vuln-stats.outputs.high }}
      medium_count: ${{ steps.vuln-stats.outputs.medium }}
      low_count: ${{ steps.vuln-stats.outputs.low }}

    steps:
      - name: Record Build Start Time
        id: start-time
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Go Module Files
        run: |
          if [[ ! -f app/go.mod || ! -f app/go.sum ]]; then
            echo "Error: app/go.mod or app/go.sum missing."
            exit 1
          fi

      - name: Set image tag
        id: set-image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ github.sha }}"
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./app
          file: ./app/Dockerfile
          load: true
          push: false
          tags: ${{ steps.set-image.outputs.image }}

      - name: Generate SBOM (Syft)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.set-image.outputs.image }}
          format: cyclonedx-json
          output-file: bom.json

      - name: Extract SBOM Statistics
        id: sbom-stats
        run: |
          COMPONENT_COUNT=$(jq '.components | length' bom.json)
          echo "count=${COMPONENT_COUNT}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ SBOM Components Found: ${COMPONENT_COUNT}"

      - name: Scan for Vulnerabilities (Grype)
        uses: anchore/scan-action@v6
        with:
          sbom: bom.json
          output-file: vulnerabilities.json
          output-format: json
          fail-build: false

      - name: Extract Vulnerability Statistics
        id: vuln-stats
        run: |
          TOTAL=$(jq '.matches | length' vulnerabilities.json)
          CRITICAL=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' vulnerabilities.json)
          HIGH=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' vulnerabilities.json)
          MEDIUM=$(jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length' vulnerabilities.json)
          LOW=$(jq '[.matches[] | select(.vulnerability.severity == "Low")] | length' vulnerabilities.json)
          
          echo "total=${TOTAL}" >> $GITHUB_OUTPUT
          echo "critical=${CRITICAL}" >> $GITHUB_OUTPUT
          echo "high=${HIGH}" >> $GITHUB_OUTPUT
          echo "medium=${MEDIUM}" >> $GITHUB_OUTPUT
          echo "low=${LOW}" >> $GITHUB_OUTPUT
          
          echo "ðŸ” Vulnerabilities Found:"
          echo "   Critical: ${CRITICAL}"
          echo "   High: ${HIGH}"
          echo "   Medium: ${MEDIUM}"
          echo "   Low: ${LOW}"
          echo "   Total: ${TOTAL}"

      - name: Save Docker image to tarball
        run: docker save ${{ steps.set-image.outputs.image }} -o /tmp/docker-image.tar

      - name: Upload Artifacts (SBOM & Scan)
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bom.json
            vulnerabilities.json
          retention-days: 7

      - name: Upload Docker Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-image.tar
          retention-days: 7

      - name: Record Build End Time
        id: end-time
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

  policy-gate:
    name: 2 - Enforce Security Policy
    runs-on: ubuntu-latest
    needs: [build]
    outputs:
      image_tag: ${{ needs.build.outputs.image_tag }}
      policy_start_time: ${{ steps.policy-start.outputs.time }}
      policy_end_time: ${{ steps.policy-end.outputs.time }}
      policy_result: ${{ steps.opa_eval.outputs.passed }}
      policy_violations: ${{ steps.opa_eval.outputs.violations }}

    steps:
      - name: Record Policy Check Start Time
        id: policy-start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: .

      - name: Install OPA
        run: |
          curl -L -o /tmp/opa https://github.com/open-policy-agent/opa/releases/latest/download/opa_linux_amd64
          chmod +x /tmp/opa
          sudo mv /tmp/opa /usr/local/bin/opa

      - name: Create OPA input JSON
        run: |
          jq -n --slurpfile grype vulnerabilities.json --slurpfile syft bom.json \
            '{"vulnerabilities": $grype[0], "sbom": $syft[0]}' > input.json

      - name: Run OPA Policy Gate
        id: opa_eval
        run: |
          # Evaluate allow policy
          RESULT=$(opa eval -i input.json -d ./policy 'data.main.allow' --format=json 2>&1) || true
          PASSED=$(echo "$RESULT" | jq -r '.result[0].expressions[0].value // "false"')
          echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          
          # Get violation details
          VIOLATIONS=$(opa eval -i input.json -d ./policy 'data.main.deny' --format=json 2>/dev/null || echo '{"result":[{"expressions":[{"value":[]}]}]}')
          VIOLATION_COUNT=$(echo "$VIOLATIONS" | jq -r '.result[0].expressions[0].value | length')
          echo "violations=${VIOLATION_COUNT}" >> $GITHUB_OUTPUT
          
          echo "ðŸ›¡ï¸ Policy Evaluation Results:"
          echo "   Status: ${PASSED}"
          echo "   Violations: ${VIOLATION_COUNT}"
          
          if [ "$PASSED" != "true" ]; then
            echo "âŒ OPA Policy FAILED - Violations found:"
            echo "$VIOLATIONS" | jq -r '.result[0].expressions[0].value[]'
            exit 1
          fi
          
          echo "âœ… OPA Policy PASSED"

      - name: Record Policy Check End Time
        id: policy-end
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

  sign-and-publish:
    name: 3 - Attest and Publish
    runs-on: ubuntu-latest
    needs: [policy-gate]
    permissions:
      contents: read
      packages: write
      id-token: write

    outputs:
      sign_start_time: ${{ steps.sign-start.outputs.time }}
      sign_end_time: ${{ steps.sign-end.outputs.time }}
      image_digest: ${{ steps.digest.outputs.digest }}
      signature_verified: ${{ steps.verify-sig.outputs.verified }}
      attestation_verified: ${{ steps.verify-att.outputs.verified }}

    steps:
      - name: Record Signing Start Time
        id: sign-start
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/docker-image.tar

      - name: Set IMAGE variable from upstream
        run: echo "IMAGE=${{ needs.policy-gate.outputs.image_tag }}" >> $GITHUB_OUTPUT
        id: setimage

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Docker image to registry
        run: docker push ${{ steps.setimage.outputs.IMAGE }}

      - name: Get image digest
        id: digest
        run: |
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ steps.setimage.outputs.IMAGE }})
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "ðŸ” Image Digest: ${DIGEST}"

      - name: Download SBOM artifact
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: .

      - name: Install Sigstore/cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign image with Cosign (keyless)
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          echo "ðŸ” Signing image with Sigstore..."
          cosign sign --yes ${{ steps.digest.outputs.digest }}
          echo "âœ… Image signed successfully"

      - name: Attach SBOM Attestation
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          echo "ðŸ“‹ Attaching SBOM attestation..."
          cosign attest --yes --type cyclonedx --predicate ./bom.json ${{ steps.digest.outputs.digest }}
          echo "âœ… SBOM attestation attached"

      - name: Verify Image Signature
        id: verify-sig
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          echo "ðŸ” Verifying image signature..."
          cosign verify \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            --certificate-identity-regexp "^https://github.com/${{ github.repository }}/.*" \
            ${{ steps.digest.outputs.digest }}
          echo "verified=true" >> $GITHUB_OUTPUT
          echo "âœ… Signature verified successfully"

      - name: Verify SBOM Attestation
        id: verify-att
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          echo "ðŸ” Verifying SBOM attestation..."
          cosign verify-attestation \
            --type cyclonedx \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            --certificate-identity-regexp "^https://github.com/${{ github.repository }}/.*" \
            ${{ steps.digest.outputs.digest }}
          echo "verified=true" >> $GITHUB_OUTPUT
          echo "âœ… Attestation verified successfully"

      - name: Record Signing End Time
        id: sign-end
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

  metrics:
    name: 4 - Collect and Report Metrics
    runs-on: ubuntu-latest
    needs: [build, policy-gate, sign-and-publish]
    if: always()
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Calculate Pipeline Metrics
        id: calculate
        run: |
          # Time calculations
          BUILD_START=${{ needs.build.outputs.build_start_time }}
          BUILD_END=${{ needs.build.outputs.build_end_time }}
          POLICY_START=${{ needs.policy-gate.outputs.policy_start_time }}
          POLICY_END=${{ needs.policy-gate.outputs.policy_end_time }}
          SIGN_START=${{ needs.sign-and-publish.outputs.sign_start_time }}
          SIGN_END=${{ needs.sign-and-publish.outputs.sign_end_time }}
          
          BUILD_DURATION=$((BUILD_END - BUILD_START))
          POLICY_DURATION=$((POLICY_END - POLICY_START))
          SIGN_DURATION=$((SIGN_END - SIGN_START))
          TOTAL_DURATION=$((SIGN_END - BUILD_START))
          
          echo "build_duration=${BUILD_DURATION}" >> $GITHUB_OUTPUT
          echo "policy_duration=${POLICY_DURATION}" >> $GITHUB_OUTPUT
          echo "sign_duration=${SIGN_DURATION}" >> $GITHUB_OUTPUT
          echo "total_duration=${TOTAL_DURATION}" >> $GITHUB_OUTPUT
          
          echo "â±ï¸ Pipeline Duration Metrics:"
          echo "   Build & Scan: ${BUILD_DURATION}s"
          echo "   Policy Check: ${POLICY_DURATION}s"
          echo "   Sign & Publish: ${SIGN_DURATION}s"
          echo "   Total: ${TOTAL_DURATION}s"

      - name: Create Metrics Report
        run: |
          mkdir -p metrics
          cat > metrics/run-${{ github.run_number }}.json << EOF
          {
            "run_number": ${{ github.run_number }},
            "run_id": "${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit_sha": "${{ github.sha }}",
            "performance": {
              "build_duration_seconds": ${{ steps.calculate.outputs.build_duration }},
              "policy_duration_seconds": ${{ steps.calculate.outputs.policy_duration }},
              "signing_duration_seconds": ${{ steps.calculate.outputs.sign_duration }},
              "total_duration_seconds": ${{ steps.calculate.outputs.total_duration }}
            },
            "security": {
              "sbom_components": ${{ needs.build.outputs.sbom_components_count }},
              "vulnerabilities": {
                "critical": ${{ needs.build.outputs.critical_count }},
                "high": ${{ needs.build.outputs.high_count }},
                "medium": ${{ needs.build.outputs.medium_count }},
                "low": ${{ needs.build.outputs.low_count }},
                "total": ${{ needs.build.outputs.vulnerabilities_found }}
              },
              "policy_passed": ${{ needs.policy-gate.outputs.policy_result }},
              "policy_violations": ${{ needs.policy-gate.outputs.policy_violations }},
              "signature_verified": ${{ needs.sign-and-publish.outputs.signature_verified }},
              "attestation_verified": ${{ needs.sign-and-publish.outputs.attestation_verified }}
            },
            "slsa_compliance": {
              "level": "2",
              "provenance_generated": true,
              "non_falsifiable": true,
              "hermetic_build": false
            }
          }
          EOF
          
          echo "ðŸ“Š Metrics saved to metrics/run-${{ github.run_number }}.json"
          cat metrics/run-${{ github.run_number }}.json

      - name: Generate Markdown Report
        run: |
          cat > metrics/run-${{ github.run_number }}.md << EOF
          # DevSecOps Pipeline Metrics Report
          
          **Run Number:** ${{ github.run_number }}  
          **Commit:** \`${{ github.sha }}\`  
          **Timestamp:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          
          ## â±ï¸ Performance Metrics
          
          | Stage | Duration |
          |-------|----------|
          | Build & Scan | ${{ steps.calculate.outputs.build_duration }}s |
          | Policy Check | ${{ steps.calculate.outputs.policy_duration }}s |
          | Sign & Publish | ${{ steps.calculate.outputs.sign_duration }}s |
          | **Total** | **${{ steps.calculate.outputs.total_duration }}s** |
          
          ## ðŸ”’ Security Metrics
          
          ### SBOM Analysis
          - **Components Found:** ${{ needs.build.outputs.sbom_components_count }}
          
          ### Vulnerability Scan
          | Severity | Count |
          |----------|-------|
          | Critical | ${{ needs.build.outputs.critical_count }} |
          | High | ${{ needs.build.outputs.high_count }} |
          | Medium | ${{ needs.build.outputs.medium_count }} |
          | Low | ${{ needs.build.outputs.low_count }} |
          | **Total** | **${{ needs.build.outputs.vulnerabilities_found }}** |
          
          ### Policy Enforcement
          - **Status:** ${{ needs.policy-gate.outputs.policy_result == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}
          - **Violations:** ${{ needs.policy-gate.outputs.policy_violations }}
          
          ### Cryptographic Verification
          - **Signature Verified:** ${{ needs.sign-and-publish.outputs.signature_verified == 'true' && 'âœ…' || 'âŒ' }}
          - **Attestation Verified:** ${{ needs.sign-and-publish.outputs.attestation_verified == 'true' && 'âœ…' || 'âŒ' }}
          
          ## ðŸ† SLSA Compliance
          - **Level Achieved:** 2
          - **Provenance:** Generated
          - **Non-falsifiable:** Yes
          - **Hermetic Build:** No (Level 3 requirement)
          
          ---
          *Generated by DevSecOps Pipeline v1.0*
          EOF
          
          cat metrics/run-${{ github.run_number }}.md

      - name: Upload Metrics Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pipeline-metrics
          path: metrics/
          retention-days: 90

      - name: Summary Comment
        run: |
          echo "## ðŸ“Š DevSecOps Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â±ï¸ Performance" >> $GITHUB_STEP_SUMMARY
          echo "- Total Duration: **${{ steps.calculate.outputs.total_duration }}s**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”’ Security" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM Components: **${{ needs.build.outputs.sbom_components_count }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerabilities: **${{ needs.build.outputs.vulnerabilities_found }}** (C:${{ needs.build.outputs.critical_count }} H:${{ needs.build.outputs.high_count }} M:${{ needs.build.outputs.medium_count }} L:${{ needs.build.outputs.low_count }})" >> $GITHUB_STEP_SUMMARY
          echo "- Policy Status: **${{ needs.policy-gate.outputs.policy_result == 'true' && 'âœ… PASSED' || 'âŒ FAILED' }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ† SLSA Level 2 Compliance: âœ…" >> $GITHUB_STEP_SUMMARY