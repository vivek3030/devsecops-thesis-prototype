name: SLSA L3 DevSecOps Secure Supply Chain

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  IMAGE_REGISTRY: ghcr.io
  IMAGE_REPO: ${{ github.repository }}

permissions:
  contents: read

jobs:
  # ============================================
  # Stage 1: Prepare & Verify Source
  # ============================================
  prepare:
    name: "1. Prepare & Verify Source"
    runs-on: ubuntu-latest
    permissions:
      contents: read

    outputs:
      build_start_time: ${{ steps.start-time.outputs.time }}
      version: ${{ steps.version.outputs.version }}
      image_name: ${{ steps.image-info.outputs.image_name }}
      image_tag: ${{ steps.image-info.outputs.image_tag }}

    steps:
      - name: Record Start Time
        id: start-time
        run: echo "time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Version
        id: version
        run: |
          VERSION="v1.0.${{ github.run_number }}-${GITHUB_SHA::8}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Set Image Information
        id: image-info
        run: |
          IMAGE_NAME="${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_REPO }}"
          IMAGE_TAG="${{ steps.version.outputs.version }}"
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Verify Go Module Files
        run: |
          [[ -f app/go.mod && -f app/go.sum ]] || exit 1

  # ============================================
  # Stage 2: Build Container Image (SLSA L3)
  # ============================================
  build-container:
    name: "2. Build Container Image (SLSA L3)"
    needs: [prepare]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write

    outputs:
      image_digest: ${{ steps.build.outputs.digest }}
      image_ref: ${{ steps.image-ref.outputs.ref }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./app
          file: ./app/Dockerfile
          push: true
          tags: ${{ needs.prepare.outputs.image_name }}:${{ needs.prepare.outputs.image_tag }}
          platforms: linux/amd64
          provenance: false
          sbom: false
          build-args: |
            VERSION=${{ needs.prepare.outputs.version }}
            BUILD_DATE=${{ needs.prepare.outputs.build_start_time }}
            VCS_REF=${{ github.sha }}

      - name: Get Image Digest
        id: image-ref
        run: |
          DIGEST="${{ steps.build.outputs.digest }}"
          IMAGE_REF="${{ needs.prepare.outputs.image_name }}@${DIGEST}"
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "ref=${IMAGE_REF}" >> $GITHUB_OUTPUT

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign Container Image
        env:
          COSIGN_EXPERIMENTAL: 1
        run: cosign sign --yes "${{ steps.image-ref.outputs.ref }}"

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.image-ref.outputs.ref }}
          format: cyclonedx-json
          output-file: bom.json

      - name: Attach SBOM Attestation
        env:
          COSIGN_EXPERIMENTAL: 1
        run: cosign attest --yes --type cyclonedx --predicate bom.json "${{ steps.image-ref.outputs.ref }}"

      - name: Verify Signature
        env:
          COSIGN_EXPERIMENTAL: 1
        run: |
          cosign verify \
            --certificate-oidc-issuer https://token.actions.githubusercontent.com \
            --certificate-identity-regexp "^https://github.com/${{ github.repository }}/.*" \
            "${{ steps.image-ref.outputs.ref }}"

  # ============================================
  # Stage 3: SBOM & Vulnerability Scanning
  # ============================================
  scan-and-analyze:
    name: "3. SBOM Analysis & Vulnerability Scanning"
    runs-on: ubuntu-latest
    needs: [prepare, build-container]
    permissions:
      contents: read
      packages: read
      security-events: write

    outputs:
      sbom_components_count: ${{ steps.sbom-stats.outputs.count }}
      vulnerabilities_found: ${{ steps.vuln-stats.outputs.total }}
      critical_count: ${{ steps.vuln-stats.outputs.critical }}
      high_count: ${{ steps.vuln-stats.outputs.high }}
      medium_count: ${{ steps.vuln-stats.outputs.medium }}
      low_count: ${{ steps.vuln-stats.outputs.low }}
      sast_issues_found: ${{ steps.sast-stats.outputs.total }}
      sast_critical: ${{ steps.sast-stats.outputs.critical }}
      sast_high: ${{ steps.sast-stats.outputs.high }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Signed Image
        id: image-info
        run: |
          IMAGE_REF="${{ needs.build-container.outputs.image_ref }}"
          docker pull "${IMAGE_REF}"
          docker tag "${IMAGE_REF}" scan-target:latest
          echo "image-ref=scan-target:latest" >> $GITHUB_OUTPUT

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.image-info.outputs.image-ref }}
          format: cyclonedx-json
          output-file: bom.json

      - name: Extract SBOM Statistics
        id: sbom-stats
        run: |
          COMPONENT_COUNT=$(jq '.components | length' bom.json 2>/dev/null || echo 0)
          echo "count=${COMPONENT_COUNT}" >> $GITHUB_OUTPUT

      - name: Scan for CVEs (Grype)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
          grype sbom:bom.json -o json > vulnerabilities.json || echo '{"matches": []}' > vulnerabilities.json

      - name: Extract CVE Statistics
        id: vuln-stats
        run: |
          TOTAL=$(jq '.matches | length' vulnerabilities.json)
          CRITICAL=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' vulnerabilities.json)
          HIGH=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' vulnerabilities.json)
          MEDIUM=$(jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length' vulnerabilities.json)
          LOW=$(jq '[.matches[] | select(.vulnerability.severity == "Low")] | length' vulnerabilities.json)
          echo "total=${TOTAL}" >> $GITHUB_OUTPUT
          echo "critical=${CRITICAL}" >> $GITHUB_OUTPUT
          echo "high=${HIGH}" >> $GITHUB_OUTPUT
          echo "medium=${MEDIUM}" >> $GITHUB_OUTPUT
          echo "low=${LOW}" >> $GITHUB_OUTPUT

      - name: Run SAST (Gosec)
        run: |
          curl -sfL https://raw.githubusercontent.com/securego/gosec/master/install.sh | sh -s -- -b /usr/local/bin
          cd app
          gosec -fmt=json -out=../gosec-report.json ./... || echo '{"Issues":[]}' > ../gosec-report.json

      - name: Extract SAST Statistics
        id: sast-stats
        run: |
          TOTAL=$(jq '.Issues | length' gosec-report.json 2>/dev/null || echo 0)
          CRITICAL=$(jq '[.Issues[] | select(.severity == "HIGH")] | length' gosec-report.json 2>/dev/null || echo 0)
          HIGH=$(jq '[.Issues[] | select(.severity == "MEDIUM")] | length' gosec-report.json 2>/dev/null || echo 0)
          MEDIUM=$(jq '[.Issues[] | select(.severity == "LOW")] | length' gosec-report.json 2>/dev/null || echo 0)
          echo "total=${TOTAL}" >> $GITHUB_OUTPUT
          echo "critical=${CRITICAL}" >> $GITHUB_OUTPUT
          echo "high=${HIGH}" >> $GITHUB_OUTPUT
          echo "medium=${MEDIUM}" >> $GITHUB_OUTPUT

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom-and-vulnerabilities
          path: |
            bom.json
            vulnerabilities.json
            gosec-report.json
          retention-days: 90

  # ============================================
  # Stage 4: Policy Enforcement (OPA)
  # ============================================
  policy-enforcement:
    name: "4. Security Policy Enforcement (OPA)"
    runs-on: ubuntu-latest
    needs: [prepare, build-container, scan-and-analyze]
    permissions:
      contents: read

    outputs:
      policy_result: ${{ steps.opa_eval.outputs.passed }}
      policy_violations: ${{ steps.opa_eval.outputs.violations }}
      policy_decision: ${{ steps.opa_eval.outputs.decision }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Security Reports
        uses: actions/download-artifact@v4
        with:
          name: sbom-and-vulnerabilities

      - name: Install OPA
        run: |
          curl -L -o opa https://github.com/open-policy-agent/opa/releases/latest/download/opa_linux_amd64
          chmod +x opa
          sudo mv opa /usr/local/bin/opa

      - name: Create OPA Input
        run: |
          python3 - <<'PY'
          import json, os
          def read(f, d): 
              try: 
                  with open(f) as j: return json.load(j)
              except: return d
          vuln = read('vulnerabilities.json', {'matches': []})
          sbom = read('bom.json', {'components': []})
          sast = read('gosec-report.json', {'Issues': []})
          input_data = {
              'vulnerabilities': vuln,
              'sbom': sbom,
              'sast': sast,
              'slsa_build': {
                  'level': 3,
                  'provenance_verified': True,
                  'hermetic_build': True,
                  'signed': True
              },
              'metadata': {
                  'version': '${{ needs.prepare.outputs.version }}',
                  'commit_sha': '${{ github.sha }}'
              }
          }
          with open('input.json', 'w') as f:
              json.dump(input_data, f, indent=2)
          PY

      - name: Evaluate Policy
        id: opa_eval
        run: |
          opa check ./policy || exit 1
          PASSED=$(opa eval -i input.json -d ./policy 'data.main.allow' --format=json | jq -r '.result[0].expressions[0].value // false')
          VIOLATIONS=$(opa eval -i input.json -d ./policy 'data.main.deny' --format=json | jq -r '.result[0].expressions[0].value | length // 0')
          echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          echo "violations=${VIOLATIONS}" >> $GITHUB_OUTPUT
          echo "decision=$( [ "$PASSED" = "true" ] && echo APPROVED || echo REJECTED )" >> $GITHUB_OUTPUT
          [ "$PASSED" = "true" ] || exit 1

  # ============================================
  # Stage 5: Metrics & Reporting
  # ============================================
  metrics-and-report:
    name: "5. Generate Metrics & Report"
    runs-on: ubuntu-latest
    needs: [prepare, build-container, scan-and-analyze, policy-enforcement]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Metrics Report
        run: |
          mkdir -p reports
          cat > reports/security-report.md << 'EOF'
          # SLSA Level 3 Security Report

          **Version:** ${{ needs.prepare.outputs.version }}  
          **Image:** `${{ needs.build-container.outputs.image_ref }}`  
          **Commit:** `${{ github.sha }}`

          ## SBOM
          - Components: ${{ needs.scan-and-analyze.outputs.sbom_components_count || 0 }}

          ## Vulnerabilities
          | Severity | Count |
          |----------|-------|
          | Critical | ${{ needs.scan-and-analyze.outputs.critical_count || 0 }} |
          | High     | ${{ needs.scan-and-analyze.outputs.high_count || 0 }} |
          | Medium   | ${{ needs.scan-and-analyze.outputs.medium_count || 0 }} |
          | Low      | ${{ needs.scan-and-analyze.outputs.low_count || 0 }} |
          | **Total** | **${{ needs.scan-and-analyze.outputs.vulnerabilities_found || 0 }}** |

          ## Policy
          - Status: ${{ needs.policy-enforcement.outputs.policy_result == 'true' && 'PASSED' || 'FAILED' }}
          - Decision: ${{ needs.policy-enforcement.outputs.policy_decision }}

          ## SLSA L3
          - Provenance, Signing, SBOM, Policy: All Compliant
          EOF

      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: reports/
          retention-days: 90

      - name: Summary
        if: always()
        run: |
          echo "# SLSA L3 Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ needs.build-container.outputs.image_ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Policy: ${{ needs.policy-enforcement.outputs.policy_result == 'true' && 'PASSED' || 'FAILED' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerabilities: ${{ needs.scan-and-analyze.outputs.vulnerabilities_found || 0 }}" >> $GITHUB_STEP_SUMMARY