name: DevSecOps Secure Supply Chain

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_REPO: ${{ github.repository }}

jobs:
  build:
    name: 1 - Build and Analyze
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.set-image.outputs.image }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify Go Module Files
        run: |
          if [[ ! -f app/go.mod || ! -f app/go.sum ]]; then
            echo "Error: app/go.mod or app/go.sum missing. Please commit these files."
            exit 1
          else
            echo "app/go.mod and app/go.sum found."
          fi

      - name: Set image variable (canonical tag)
        id: set-image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_REPO }}:${{ github.sha }}"
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image (load locally)
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./app
          file: ./app/Dockerfile
          push: false
          load: true
          tags: ${{ steps.set-image.outputs.image }}

      - name: Record security-start timestamp
        id: ts_start
        run: echo "START=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Generate SBOM (Syft via Anchore Action)
        uses: anchore/sbom-action@v0
        with:
          image: ${{ steps.set-image.outputs.image }}
          format: cyclonedx-json
          output-file: bom.json

      - name: Scan for Vulnerabilities (Grype via Anchore Action)
        uses: anchore/scan-action@v6
        with:
          sbom: bom.json
          output-file: vulnerabilities.json
          output-format: json
          fail-build: false

      - name: Record security-end timestamp
        id: ts_end
        run: echo "END=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Calculate and upload durations
        run: |
          START=${{ steps.ts_start.outputs.START }}
          END=${{ steps.ts_end.outputs.END }}
          DURATION=$((END-START))
          echo "start=${START},end=${END},security_duration_seconds=${DURATION}" > duration.properties
      - name: Upload duration artifact
        uses: actions/upload-artifact@v4
        with:
          name: duration
          path: duration.properties
          retention-days: 7

      - name: Save Docker image to tarball
        run: docker save ${{ steps.set-image.outputs.image }} -o /tmp/docker-image.tar

      - name: Upload Artifacts (SBOM & Scan)
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bom.json
            vulnerabilities.json
          retention-days: 7

      - name: Upload Docker Image Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/docker-image.tar
          retention-days: 7

  policy-gate:
    name: 2 - Enforce Security Policy
    runs-on: ubuntu-latest
    needs: [build]
    outputs:
      image_tag: ${{ needs.build.outputs.image_tag }}

    steps:
      - name: Checkout repository (for OPA policy files)
        uses: actions/checkout@v4

      - name: Download security reports
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: .

      - name: Install Open Policy Agent (OPA)
        run: |
          curl -L -o /tmp/opa https://github.com/open-policy-agent/opa/releases/latest/download/opa_linux_amd64
          chmod +x /tmp/opa
          sudo mv /tmp/opa /usr/local/bin/opa
          opa version

      - name: Create OPA Input JSON
        run: |
          jq -n --slurpfile grype vulnerabilities.json --slurpfile syft bom.json \
            '{"vulnerabilities": $grype[0], "sbom": $syft[0]}' > input.json
          echo "Input prepared for OPA:"
          jq . input.json

      - name: Run OPA Policy Gate (deterministic)
        id: opa_eval
        run: |
          # Evaluate the policy; output JSON to parse
          RESULT=$(opa eval -i input.json -d ./policy 'data.main.allow' --format=json 2>&1) || true
          echo "OPA raw result: $RESULT"
          # Try to extract boolean result
          PASSED=$(echo "$RESULT" | jq -r '.result[0].expressions[0].value // "false"')
          echo "passed=${PASSED}" >> $GITHUB_OUTPUT
          if [ "$PASSED" != "true" ]; then
            echo "OPA policy evaluation did NOT pass. Printing allow expression result and deny messages..."
            # Try to print deny messages (if policy provides them)
            DENY=$(opa eval -i input.json -d ./policy 'data.main.deny' --format=json 2>/dev/null || true)
            echo "DENY output: $DENY"
            exit 1
          fi
          echo "OPA Policy PASSED"

  sign-and-publish:
    name: 3 - Attest and Publish
    runs-on: ubuntu-latest
    needs: [policy-gate]
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout repo (for attestations)
        uses: actions/checkout@v4

      - name: Download Docker Image Artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load -i /tmp/docker-image.tar

      - name: Set IMAGE variable from upstream
        run: |
          echo "IMAGE=${{ needs.policy-gate.outputs.image_tag }}" >> $GITHUB_OUTPUT
        id: setimage

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Retag loaded image to canonical tag (if needed) & Push
        run: |
          # Attempt to find the loaded image ID (first image), then tag to canonical and push
          LOADED_IMAGE=$(docker images --format "{{.Repository}}:{{.Tag}}" | head -n 1 || true)
          echo "Loaded image (first): $LOADED_IMAGE"
          docker tag "$LOADED_IMAGE" "${{ needs.policy-gate.outputs.image_tag }}" || true
          docker push "${{ needs.policy-gate.outputs.image_tag }}"

      - name: Install Sigstore/cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign the image with Cosign (keyless)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign sign --keyless "${{ needs.policy-gate.outputs.image_tag }}"

      - name: Download SBOM report
        uses: actions/download-artifact@v4
        with:
          name: security-reports
          path: .

      - name: Attach SBOM Attestation (cosign attest, keyless)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign attest --type cyclonedx --predicate ./bom.json --keyless "${{ needs.policy-gate.outputs.image_tag }}"

      - name: Verify Image Signature (keyless)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          cosign verify --keyless "${{ needs.policy-gate.outputs.image_tag }}"
